(function(){var t,r,e,i,n,o={}.hasOwnProperty,h=function(t,r){function e(){this.constructor=t}for(var i in r)o.call(r,i)&&(t[i]=r[i]);return e.prototype=r.prototype,t.prototype=new e,t.__super__=r.prototype,t};n=ABM.util,ABM.DataSet=r=function(){function r(t,r,e){null==t&&(t=0),null==r&&(r=0),null==e&&(e=[]),this.setDefaults(),this.reset(t,r,e)}return r.patchDataSet=function(t){return new i(t)},r.importImageDataSet=function(t,r,i,o,h){var a;return null==i&&(i=n.pixelByte(0)),null==o&&(o=Uint8ClampedArray),a=new e(null,i,o,h),n.importImage(t,function(t){return a.parse(t),null!=r?r(a):void 0}),a},r.importAscDataSet=function(r,e){var i;return i=new t,n.xhrLoadFile(r,"GET","text",function(t){return i.parse(t),null!=e?e(i):void 0}),i},r.prototype.reset=function(t,r,e){return this.width=t,this.height=r,this.data=e,e.length!==t*r&&n.error("DataSet: data array length error:\ndata.length: "+this.data.length+" width: "+this.width+" height: "+this.height),this},r.prototype.checkXY=function(t,r){return t>=0&&t<=this.width-1&&r>=0&&r<=this.height-1?void 0:n.error("x,y out of range: "+t+","+r)},r.prototype.setDefaults=function(){return this.useNearest=!1,this.crop=!1,this.normalizeImage=!0,this.alpha=255,this.gray=!0},r.prototype.setSampler=function(t){this.useNearest=t},r.prototype.setConvolveCrop=function(t){this.crop=t},r.prototype.setImageNormalize=function(t){this.normalizeImage=t},r.prototype.setImageAlpha=function(t){this.alpha=t},r.prototype.setImageGray=function(t){this.gray=t},r.prototype.sample=function(t,r){return this.useNearest?this.nearest(t,r):this.bilinear(t,r)},r.prototype.nearest=function(t,r){return this.getXY(Math.round(t),Math.round(r))},r.prototype.bilinear=function(t,r){var e,i,n,o,h,a,s,u,l,p,c,d,f;return this.checkXY(t,r),l=Math.floor(t),p=Math.floor(r),s=this.toIndex(l,p),u=this.width,t-=l,r-=p,e=1-t,i=1-r,n=this.data[s],o=null!=(c=this.data[s+u])?c:0,h=null!=(d=this.data[++s])?d:0,a=null!=(f=this.data[s+u])?f:0,n*e*i+h*t*i+o*e*r+a*t*r},r.prototype.toIndex=function(t,r){return t+r*this.width},r.prototype.toXY=function(t){return[t%this.width,Math.floor(t/this.width)]},r.prototype.getXY=function(t,r){return this.checkXY(t,r),this.data[this.toIndex(t,r)]},r.prototype.setXY=function(t,r,e){return this.checkXY(t,r),this.data[this.toIndex(t,r)]=e},r.prototype.toString=function(t,r){var e,i,o,h,a;for(null==t&&(t=2),null==r&&(r=", "),o="width: "+this.width+" height: "+this.height+" data:",e=0>t?this.data:n.aToFixed(this.data,t),i=h=0,a=this.height;a>=0?a>h:h>a;i=a>=0?++h:--h)o+="\n"+(""+i+": "+e.slice(i*this.width,(i+1)*this.width));return o.replace(/,/g,r)},r.prototype.toImage=function(){return this.toContext().canvas},r.prototype.toContext=function(){var t,r,e,i,o,h,a,s,u,l;for(t=n.createCtx(this.width,this.height),o=t.getImageData(0,0,this.width,this.height),s=o.data,e=this.normalizeImage?this.gray?n.normalize8(this.data):n.normalizeInt(this.data,0,Math.pow(2,24)-1):function(){var t,e,i,n;for(i=this.data,n=[],t=0,e=i.length;e>t;t++)r=i[t],n.push(Math.round(r));return n}.call(this),i=u=0,l=e.length;l>u;i=++u)a=e[i],h=4*i,s[h+3]=this.alpha,this.gray?s[h]=s[h+1]=s[h+2]=Math.floor(a):(s[h]=a>>16&255,s[h+1]=a>>8&255,s[h+2]=255&a,s[h+3]=a>>24&255);return t.putImageData(o,0,0),t},r.prototype.toDrawing=function(){var t;return ABM.patches.installDrawing(t=this.toImage()),t},r.prototype.toPatchColors=function(){var t;return ABM.patches.installColors(t=this.toImage()),t},r.prototype.toPatchVar=function(t){var r,e,i,n,o,h,a;if((i=ABM.patches).length===this.data.length)for(r=n=0,h=i.length;h>n;r=++n)e=i[r],e[t]=this.data[r];else for(o=0,a=i.length;a>o;o++)e=i[o],e[t]=this.patchSample(e.x,e.y);return null},r.prototype.coordSample=function(t,r,e,i,n,o){var h,a;return h=(t-e)*(this.width-1)/n,a=(i-r)*(this.height-1)/o,this.sample(h,a)},r.prototype.patchSample=function(t,r){var e;return e=ABM.world,this.coordSample(t,r,e.minXcor,e.maxYcor,e.numX,e.numY)},r.prototype.normalize=function(t,e){return new r(this.width,this.height,n.normalize(this.data,t,e))},r.prototype.normalize8=function(){return new r(this.width,this.height,n.normalize8(this.data))},r.prototype.resample=function(t,e){var i,n,o,h,a,s,u,l,p;if(t===this.width&&e===this.height)return new r(t,e,this.data);for(i=[],o=(this.width-1)/(t-1),s=(this.height-1)/(e-1),a=l=0;e>l;a=l+=1)for(n=p=0;t>p;n=p+=1)h=n*o,u=a*s,i.push(this.sample(h,u));return new r(t,e,i)},r.prototype.neighborhood=function(t,r,e){var i,o,h,a,s,u;for(null==e&&(e=[]),e.length=0,o=s=-1;1>=s;o=++s)for(i=u=-1;1>=u;i=++u)h=n.clamp(t+i,0,this.width-1),a=n.clamp(r+o,0,this.height-1),e.push(this.data[this.toIndex(h,a)]);return e},r.prototype.convolve=function(t,e){var i,o,h,a,s,u,l,p,c,d;for(null==e&&(e=1),i=[],h=[],this.crop?(u=p=1,o=this.height-1,a=this.width-1):(u=p=0,o=this.height,a=this.width),l=c=p;o>c;l=c+=1)for(s=d=u;a>d;s=d+=1)this.neighborhood(s,l,h),i.push(n.aSum(n.aPairMul(t,h))*e);return new r(a-u,o-p,i)},r.prototype.dzdx=function(t,r){return null==t&&(t=2),null==r&&(r=1/8),this.convolve([-1,0,1,-t,0,t,-1,0,1],r)},r.prototype.dzdy=function(t,r){return null==t&&(t=2),null==r&&(r=1/8),this.convolve([1,t,1,0,0,0,-1,-t,-1],r)},r.prototype.laplace8=function(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])},r.prototype.laplace4=function(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])},r.prototype.blur=function(t){return null==t&&(t=.0625),this.convolve([1,2,1,2,4,2,1,2,1],t)},r.prototype.edge=function(){return this.convolve([1,1,1,1,-7,1,1,1,1])},r.prototype.filter=function(t){var e;return new r(this.width,this.height,function(){var r,i,n,o;for(n=this.data,o=[],r=0,i=n.length;i>r;r++)e=n[r],o.push(t(e));return o}.call(this))},r.prototype.slopeAndAspect=function(t,e){var i,o,h,a,s,u,l,p,c,d,f,g,y;for(null==t&&(t=!0),null==e&&(e=!0),o=this.dzdx(),h=this.dzdy(),i=[],p=[],u=o.height,c=o.width,f=g=0;u>g;f=g+=1)for(d=y=0;c>y;d=y+=1){for(a=o.getXY(d,f),s=h.getXY(d,f),p.push(Math.atan(Math.sqrt(a*a+s*s)));t&&a===s;)a+=n.randomNormal(0,1e-4),s+=n.randomNormal(0,1e-4);l=a===s&&0===s?0/0:Math.atan2(-s,-a),e&&0>l&&(l+=2*Math.PI),i.push(l)}return p=new r(c,u,p),i=new r(c,u,i),n.aToObj([p,i,o,h],["slope","aspect","dzdx","dzdy"])},r.prototype.subset=function(t,e,i,o){var h,a,s,u,l,p,c;for((t+i>this.width||e+o>this.height)&&n.error("subSet: params out of range"),h=[],s=u=e,p=e+o;p>u;s=u+=1)for(a=l=t,c=t+i;c>l;a=l+=1)h.push(this.getXY(a,s));return new r(i,o,h)},r}(),ABM.AscDataSet=t=function(t){function r(t){this.str=null!=t?t:"",r.__super__.constructor.call(this),0!==this.str.length&&this.parse(this.str)}return h(r,t),r.prototype.parse=function(t){var r,e,i,n,o,h,a,s,u;for(this.str=t,n=t.split("\n"),this.header={},r=o=0;5>=o;r=++o)e=n[r].split(/\s+/),this.header[e[0].toLowerCase()]=parseFloat(e[1]);for(r=h=0,s=this.header.nrows;s>h;r=h+=1){for(i=n[6+r].trim().split(" "),r=a=0,u=i.length;u>=0?u>a:a>u;r=u>=0?++a:--a)i[r]=parseFloat(i[r]);this.data=this.data.concat(i)}return this.reset(this.header.ncols,this.header.nrows,this.data)},r}(r),ABM.ImageDataSet=e=function(t){function r(t,e,i,o){this.f=null!=e?e:n.pixelByte(0),this.arrayType=null!=i?i:Uint8ClampedArray,this.rowsPerSlice=o,r.__super__.constructor.call(this),null!=t&&this.parse(t)}return h(r,t),r.prototype.parse=function(t){var r;return this.rowsPerSlice||(this.rowsPerSlice=t.height),r=n.imageRowsToData(t,this.rowsPerSlice,this.f,this.arrayType),this.reset(t.width,t.height,r)},r}(r),ABM.PatchDataSet=i=function(t){function r(t,e){var i,o,h,a,s,u;for(null==e&&(e=Array),i=new e((a=ABM.patches).length),n.isString(t)&&(t=n.propFcn(t)),o=s=0,u=a.length;u>s;o=++s)h=a[o],i[o]=t(h);r.__super__.constructor.call(this,a.numX,a.numY,i),this.useNearest=!0}return h(r,t),r.prototype.toPatchVar=function(t){var r,e,i,n,o;for(o=ABM.patches,r=i=0,n=o.length;n>i;r=++i)e=o[r],e[t]=this.data[r];return null},r}(r)}).call(this);